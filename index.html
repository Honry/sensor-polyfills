
<script type="module">
import {
  Sensor,
  AbsoluteOrientationSensor,
  RelativeOrientationSensor,
  Gyroscope,
  Accelerometer,
  LinearAccelerationSensor,
  GravitySensor
} from './motion-sensors.js';

let log = console.log;
console.log = (message, ...rest) => {
  const div = document.querySelector('#console');
  let child = document.createElement('div');
  if (typeof(message) === 'object') {
    child.innerText = `${message.constructor.name}{${Object.getOwnPropertyNames(message)}}`;
  }
  else
    child.innerText = message;
  div.appendChild(child);

  log.call(console, message, ...rest);
}

/*
let gyro = new Gyroscope({ frequency: 50 });

gyro.onerror = err => console.log(err);
gyro.onreading = (event) => {
  const sensor = event.target;

  const timestamp = document.querySelector('#timestamp');
  timestamp.innerHTML = `Timestamp: ${sensor.timestamp}`;

  const data = document.querySelector('#data');
  data.innerHTML = `[${sensor.alpha}, ${sensor.beta}, ${sensor.gamma}]`;
}
gyro.start();
*/

function format(num) {
  return num.toFixed(3).padStart(6).replace(' ', '&nbsp;');
}

let sensor = new RelativeOrientationSensor();

sensor.onerror = err => console.log(err);

sensor.onreading = (event) => {
    const sensor = event.target;

    let mat = new Float32Array(16);
    sensor.populateMatrix(mat);
    const data = document.querySelector('#data');

    let str = "";
    for (let i = 0; i < 3; i++) {
      const a = format(mat[i * 4 + 0]);
      const b = format(mat[i * 4 + 1]);
      const c = format(mat[i * 4 + 2]);
      str += `[${a}, ${b}, ${c}]<br>`;
    }

    let mat2 = new Float32Array(16);
    sensor.populateMatrix2(mat2);

    let str2 = "";
    for (let i = 0; i < 3; i++) {
      const a = format(mat2[i * 4 + 0]);
      const b = format(mat2[i * 4 + 1]);
      const c = format(mat2[i * 4 + 2]);
      str2 += `[${a}, ${b}, ${c}]<br>`;
    }

    data.innerHTML = `E Matrix:<br>${str}<br> Q Matrix:<br>${str2}`;

    const quat = document.querySelector('#quat');

    let q = sensor.quaternion;
    const a = format(q[0]);
    const b = format(q[1]);
    const c = format(q[2]);
    const d = format(q[3]);

    let q2 = sensor.quaternion2;
    const a2 = q2[0].toFixed(3);
    const b2 = q2[1].toFixed(3);
    const c2 = q2[2].toFixed(3);
    const d2 = q2[3].toFixed(3);

    quat.innerHTML = `
      Quaternion: [${a}, ${b}, ${c}, ${d}]
      Mat Quaternion: [${a2}, ${b2}, ${c2}, ${d2}]`;

    const timestamp = document.querySelector('#timestamp');
    timestamp.innerHTML = `Timestamp: ${sensor.timestamp}`;
  }
  sensor.onactivate = _ => {
    console.log("activating");
    console.log("activated: " + sensor.activated);
  };
  console.log(sensor instanceof Sensor);
  console.log(sensor instanceof EventTarget);
  console.log(sensor);
  sensor.start();

</script>

<body>
  <div id="data"></div>
  <div id="quat"></div>
  <div id="timestamp"></div>
  <div id="console"></div>
</body>
